<!DOCTYPE html>
<html lang="es" x-data="dashboard()" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Financiero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-blue-600 text-white p-4 flex justify-between">
    <h1 class="text-xl font-bold">Gestión de Finanzas</h1>
    <button @click="cerrarSesion" class="bg-red-500 px-4 py-2 rounded">Cerrar sesión</button>
  </nav>

  <!-- Dashboard -->
  <div class="p-6 max-w-4xl mx-auto" x-data="dashboard()">
    <h2 class="text-2xl font-bold mb-4">Panel de Control</h2>

    <!-- Resumen -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="bg-green-200 p-4 rounded shadow">
        <h3 class="font-bold">Ingresos</h3>
        <p class="text-xl" x-text="ingresos.toFixed(2)"></p>
      </div>
      <div class="bg-red-200 p-4 rounded shadow">
        <h3 class="font-bold">Gastos</h3>
        <p class="text-xl" x-text="gastos.toFixed(2)"></p>
      </div>
      <div class="bg-yellow-200 p-4 rounded shadow">
        <h3 class="font-bold">Ahorros</h3>
        <p class="text-xl" x-text="ahorros.toFixed(2)"></p>
      </div>
    </div>

    <!-- Acciones -->
    <div class="flex gap-4 mb-6">
      <button @click="mostrarIngreso = true" class="bg-green-500 text-white px-4 py-2 rounded">Agregar Ingreso</button>
      <button @click="mostrarGasto = true" class="bg-red-500 text-white px-4 py-2 rounded">Agregar Gasto</button>
    </div>

    <!-- Formulario Ingreso -->
    <div x-show="mostrarIngreso" class="mb-4">
      <input type="number" placeholder="Monto ingreso" x-model="nuevoIngreso" class="border p-2 rounded w-1/3">
      <label class="ml-2">
        <input type="checkbox" x-model="ahorrarIngreso"> Ahorrar
      </label>
      <button @click="agregarIngreso" class="bg-green-600 text-white px-4 py-2 rounded ml-2">Guardar</button>
    </div>

    <!-- Formulario Gasto -->
    <div x-show="mostrarGasto" class="mb-4">
      <input type="number" placeholder="Monto gasto" x-model="nuevoGasto" class="border p-2 rounded w-1/3">
      <button @click="agregarGasto" class="bg-red-600 text-white px-4 py-2 rounded ml-2">Guardar</button>
    </div>

    <!-- Historial -->
    <h3 class="text-xl font-bold mt-6 mb-2">Historial</h3>
    <ul>
      <template x-for="mov in historial" :key="mov.fecha">
        <li class="border-b py-2 flex justify-between">
          <span x-text="mov.tipo"></span>
          <span>$<span x-text="mov.monto"></span></span>
          <span class="text-gray-500 text-sm" x-text="mov.fecha"></span>
        </li>
      </template>
    </ul>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCwHJd-ieZQpo-zcdDUtaiLV3mHmjpbro0",
      authDomain: "gestion-finanzas-4a328.firebaseapp.com",
      projectId: "gestion-finanzas-4a328",
      storageBucket: "gestion-finanzas-4a328.firebasestorage.app",
      messagingSenderId: "444522902062",
      appId: "1:444522902062:web:988f9a206e77ae0867a5bf",
      measurementId: "G-Y0W197GH5N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Variable global para manejar desde Alpine
    window.firebaseAuth = auth;
    window.firebaseDB = db;

    // Función para guardar movimiento
    window.guardarMovimiento = async function (tipo, monto) {
      const user = auth.currentUser;
      if (!user) return;
      const movimiento = {
        tipo: tipo,
        monto: monto.toFixed(2),
        fecha: new Date().toLocaleString()
      };
      await addDoc(collection(db, "usuarios", user.uid, "movimientos"), movimiento);
    };

    // Función para obtener historial
    window.cargarHistorial = async function (callback) {
      const user = auth.currentUser;
      if (!user) return;
      const q = await getDocs(collection(db, "usuarios", user.uid, "movimientos"));
      const datos = [];
      q.forEach(doc => {
        datos.push(doc.data());
      });
      callback(datos);
    };

    // Esperar usuario logueado
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html"; // redirigir al login si no hay usuario
      }
    });

    // Alpine.js
    window.dashboard = function () {
      return {
        ingresos: 0,
        gastos: 0,
        ahorros: 0,
        historial: [],
        mostrarIngreso: false,
        mostrarGasto: false,
        nuevoIngreso: '',
        nuevoGasto: '',
        ahorrarIngreso: false,

        async init() {
          await cargarHistorial((movimientos) => {
            this.historial = movimientos;
            this.ingresos = 0;
            this.gastos = 0;
            this.ahorros = 0;
            movimientos.forEach(mov => {
              if (mov.tipo === "Ingreso") this.ingresos += parseFloat(mov.monto);
              if (mov.tipo === "Gasto") this.gastos += parseFloat(mov.monto);
              if (mov.tipo === "Ahorro") this.ahorros += parseFloat(mov.monto);
            });
          });
        },

        async agregarIngreso() {
          const monto = parseFloat(this.nuevoIngreso);
          if (!isNaN(monto) && monto > 0) {
            if (this.ahorrarIngreso) {
              this.ahorros += monto;
              this.historial.push({ tipo: 'Ahorro', monto: monto.toFixed(2), fecha: new Date().toLocaleString() });
              await guardarMovimiento('Ahorro', monto);
            } else {
              this.ingresos += monto;
              this.historial.push({ tipo: 'Ingreso', monto: monto.toFixed(2), fecha: new Date().toLocaleString() });
              await guardarMovimiento('Ingreso', monto);
            }
            this.nuevoIngreso = '';
            this.ahorrarIngreso = false;
            this.mostrarIngreso = false;
          }
        },

        async agregarGasto() {
          const monto = parseFloat(this.nuevoGasto);
          if (!isNaN(monto) && monto > 0) {
            this.gastos += monto;
            this.historial.push({ tipo: 'Gasto', monto: monto.toFixed(2), fecha: new Date().toLocaleString() });
            await guardarMovimiento('Gasto', monto);
            this.nuevoGasto = '';
            this.mostrarGasto = false;
          }
        },

        async cerrarSesion() {
          await signOut(firebaseAuth);
          window.location.href = "index.html";
        }
      }
    }
  </script>
</body>
</html>
